name: Create Release

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  release:
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    env:
      GHIDRA_VERSION: 11.4.2
      GHIDRA_DATE: 20250826
      GHIDRA_LIBS: >-
        Features/Base/lib/Base.jar
        Features/Decompiler/lib/Decompiler.jar
        Framework/Docking/lib/Docking.jar
        Framework/Generic/lib/Generic.jar
        Framework/Project/lib/Project.jar
        Framework/SoftwareModeling/lib/SoftwareModeling.jar
        Framework/Utility/lib/Utility.jar
        Framework/Gui/lib/Gui.jar
        Features/BSim/lib/BSim.jar
        Features/BSim/lib/commons-dbcp2-2.9.0.jar
        Features/BSim/lib/commons-logging-1.2.jar
        Features/BSim/lib/commons-pool2-2.11.1.jar
        Features/BSim/lib/h2-2.2.220.jar
        Features/BSim/lib/postgresql-42.7.6.jar

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    - name: Determine next version
      id: version
      run: |
        # Get latest tag, if any
        LATEST_TAG=$(git tag -l --sort=-v:refname | head -n 1)
        
        if [ -z "$LATEST_TAG" ]; then
          # No tags exist, start with 1.0
          NEW_VERSION="1.0"
        else
          # Extract version numbers
          MAJOR=$(echo $LATEST_TAG | cut -d. -f1)
          MINOR=$(echo $LATEST_TAG | cut -d. -f2)
          
          # Increment minor version
          MINOR=$((MINOR + 1))
          NEW_VERSION="${MAJOR}.${MINOR}"
        fi
        
        echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
        echo "version_dash=$(echo ${NEW_VERSION} | tr '.' '-')" >> $GITHUB_OUTPUT
        echo "Next version will be: ${NEW_VERSION}"

    - name: Download Ghidra
      run: |
        wget --no-verbose -O ghidra.zip https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_${{ env.GHIDRA_VERSION }}_build/ghidra_${{ env.GHIDRA_VERSION }}_PUBLIC_${{ env.GHIDRA_DATE }}.zip
        7z x -bd ghidra.zip

    - name: Copy Ghidra libs
      run: |
        mkdir -p ./lib
        for libfile in ${{ env.GHIDRA_LIBS }}
          do echo "Copying ${libfile} to lib/"
          cp ghidra_${{ env.GHIDRA_VERSION }}_PUBLIC/Ghidra/${libfile} ./lib/
        done

    - name: Build with Maven
      run: mvn clean package

    - name: Create release artifacts
      run: |
        VERSION_DASH="${{ steps.version.outputs.version_dash }}"
        
        # Create the inner Ghidra extension zip (GhidraMCP-X-Y.zip)
        mkdir -p release/temp/GhidraMCP/lib
        cp target/GhidraMCP.jar release/temp/GhidraMCP/lib/
        cp src/main/resources/extension.properties release/temp/GhidraMCP/
        cp src/main/resources/Module.manifest release/temp/GhidraMCP/
        
        cd release/temp
        zip -r ../GhidraMCP-${VERSION_DASH}.zip GhidraMCP/
        cd ../..
        
        # Create the outer release zip (GhidraMCP-release-X-Y.zip)
        mkdir -p release/GhidraMCP-release-${VERSION_DASH}
        cp bridge_mcp_ghidra.py release/GhidraMCP-release-${VERSION_DASH}/
        cp release/GhidraMCP-${VERSION_DASH}.zip release/GhidraMCP-release-${VERSION_DASH}/
        
        cd release
        zip -r GhidraMCP-release-${VERSION_DASH}.zip GhidraMCP-release-${VERSION_DASH}/
        cd ..
        
        # Clean up temp directory
        rm -rf release/temp release/GhidraMCP-release-${VERSION_DASH}
        
        ls -lh release/

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: GhidraMCP ${{ steps.version.outputs.version }}
        body: |
          Automated release ${{ steps.version.outputs.version }}
          
          Merged PR: #${{ github.event.pull_request.number }}
          PR Title: ${{ github.event.pull_request.title }}
        files: |
          release/GhidraMCP-release-${{ steps.version.outputs.version_dash }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
